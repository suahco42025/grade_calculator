<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Calculator | Free Online GPA & Average Tool with PDF/CSV Export</title>
    <meta name="description" content="Track grades across periods & exams with our free Grade Matrix Calculator. Calculate averages, export to PDF/CSV, save sessions. Ideal for students & teachers‚Äîmobile-friendly & secure.">
    <meta name="keywords" content="grade calculator, GPA tool, average calculator, student grades, exam tracker, PDF export, online grading">
    <meta name="author" content="Grade Calculator Team">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000"> <!-- 1-year caching fallback for images/assets -->
    <link rel="canonical" href="https://gradecalculator.vercel.app/Grade-Calculator/"> <!-- Updated to Vercel example; change to your domain -->

    <!-- Preload critical images for better caching/performance -->
    <link rel="preload" href="favicon.ico" as="image">
    <link rel="preload" href="favicon.svg" as="image">
    <link rel="preload" href="favicon-96x96.png" as="image">
    <link rel="preload" href="apple-touch-icon.png" as="image">
    <link rel="preload" href="Suahco4.png" as="image"> <!-- Profile pic -->

    <!-- FIXED: Favicons - Cleaned up paths, removed ?, added strong fallback -->
    <link rel="icon" href="favicon.ico" type="image/x-icon"> <!-- Chrome fallback -->
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">

    <!-- Open Graph for Social Sharing -->
    <meta property="og:title" content="Grade Calculator | Free Online GPA & Average Tool">
    <meta property="og:description" content="Calculate grades, track progress, and export reports. Join thousands of students using our free tool.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gradecalculator.vercel.app/Grade-Calculator/"> <!-- Updated to Vercel example -->
    <meta property="og:image" content="https://gradecalculator.vercel.app/og-image.jpg"> <!-- Add a 1200x630 promo image; update path -->
    <meta property="og:site_name" content="Grade Calculator">

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Grade Calculator | Free GPA Tool">
    <meta name="twitter:description" content="Track grades, calculate averages, export to PDF. Free and easy!">
    <meta name="twitter:image" content="https://gradecalculator.vercel.app/twitter-image.jpg"> <!-- 1200x675 image; update path -->

    <!-- Structured Data (JSON-LD for Educational App) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "EducationalOrganization",
        "name": "Grade Calculator",
        "url": "https://gradecalculator.vercel.app/Grade-Calculator/",
        "description": "Free online tool for calculating student grades, GPAs, and generating reports.",
        "applicationCategory": "EducationApplication",
        "operatingSystem": "Web",
        "featureList": ["Grade Tracking", "Average Calculation", "PDF Export", "Mobile Responsive"],
        "author": {
            "@type": "Person",
            "name": "Grade Calculator Team"
        },
        "contactPoint": {
            "@type": "ContactPoint",
            "email": "mr.suah19@gmail.com",
            "contactType": "Customer Support"
        }
    }
    </script>

    <!-- Google Verification -->
    <meta name="google-site-verification" content="qUjhpW1KYde7nCoqxXWlRgPTK_cqp92DLaia1XKVBp0" />

    <!-- Noscript Fallback -->
    <noscript>
        <style>body { padding: 20px; } .container { display: block !important; }</style>
        <div style="text-align: center; padding: 50px; background: #f4f7fa;">
            <h1>Grade Calculator</h1>
            <p>Enable JavaScript to use the full interactive tool. Track grades, calculate averages, and export reports.</p>
            <a href="mailto:mr.suah19@gmail.com">Contact Us</a>
        </div>
    </noscript>

    <!-- jsPDF + autoTable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- EmailJS for contact form -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAz0wpwEd0uswwBZZwidZ-reJ0xfExXq14",
            authDomain: "suahco4-9063e.firebaseapp.com",
            projectId: "suahco4-9063e",
            storageBucket: "suahco4-9063e.firebasestorage.app",
            messagingSenderId: "178732591567",
            appId: "1:178732591567:web:cfe66d44b4e868a1740aba"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Make auth global for other scripts
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.updateProfile = updateProfile;
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            overflow-x: auto; /* For horizontal scroll on small screens */
            margin-top: 70px; /* Clearance for fixed nav */
            position: relative;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px; /* Increased gap for better button spacing */
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px; /* Increased from 10px 20px */
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px; /* Increased from 16px */
            transition: background-color 0.3s;
            min-width: 120px; /* Added for consistency on main buttons */
        }
        button:hover {
            background-color: #2980b9;
        }
        #addSubject {
            background-color: #27ae60;
        }
        #addSubject:hover {
            background-color: #229954;
        }
        #calculate {
            background-color: #e74c3c;
        }
        #calculate:hover {
            background-color: #c0392b;
        }
        /* Download button styles */
        #downloadBtn {
            background-color: #f39c12;
        }
        #downloadBtn:hover {
            background-color: #e67e22;
        }
        #pdfBtn {
            background-color: #9b59b6;
        }
        #pdfBtn:hover {
            background-color: #8e44ad;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 20px; /* Increased from 10px */
            text-align: center;
            border: 1px solid #ddd;
            font-size: 16px; /* Added for larger text */
        }
        th {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }
        .subject-th {
            background-color: #2c3e50;
            text-align: left;
        }
        input[type="text"], input[type="number"] {
            width: 100px; /* Increased from 70px for numbers */
            padding: 10px; /* Increased from 5px */
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
            text-align: center;
            font-size: 16px; /* Added to match table */
        }
        input[type="text"] {
            width: 150px; /* Increased from 120px */
        }
        /* Red highlight for scores below threshold */
        input.low-score {
            background-color: #ffebee;
            border-color: #f44336;
            color: #d32f2f;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px; /* Increased from 3px 8px */
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px; /* Increased from 12px */
            margin-left: 5px;
        }
        .remove-btn:hover {
            background-color: #c0392b;
        }
        .average-cell {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #27ae60;
        }
        .average-cell small {
            font-size: 12px;
            color: #666;
            display: block;
        }
        .period-avg-row {
            background-color: #e8f4fd;
            font-weight: bold;
        }
        .overall-average {
            background-color: #d5f4e6;
            font-size: 18px; /* Slightly increased for emphasis */
            color: #27ae60;
        }
        .result {
            background-color: #d5f4e6;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
        }
        /* Navigation bar styling */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #2c3e50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 60px;
        }
        .nav-logo a {
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }
        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 20px;
        }
        .nav-menu li a {
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .nav-menu li a:hover {
            background-color: #34495e;
        }
        .nav-profile {
            display: flex;
            align-items: center;
            position: relative;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #3498db;
            transition: transform 0.2s;
        }
        .profile-pic:hover {
            transform: scale(1.1);
        }
        /* Profile dropdown - MINIMIZED VERSION */
        .profile-dropdown {
            position: absolute;
            top: 45px; /* Reduced from 50px for tighter fit */
            right: 0;
            background: #34495e;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* Slightly tighter shadow for minimalism */
            display: none;
            min-width: 120px; /* Reduced from 150px */
            z-index: 101;
        }
        .profile-dropdown.active {
            display: block;
        }
        .profile-dropdown a {
            display: block;
            color: white;
            padding: 8px 12px; /* Reduced from 10px 15px for compact items */
            text-decoration: none;
            transition: background 0.3s;
            font-size: 14px; /* Added: Slightly smaller font for density */
        }
        .profile-dropdown a:hover {
            background: #2c3e50;
        }
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }
        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
            transition: 0.3s;
        }
        /* Mobile: Hamburger menu - FIXED FOR REFRESH */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px; /* Increased gap */
            }
            input[type="text"], input[type="number"] {
                width: 80px; /* Increased from 50px for better mobile touch */
            }
            input[type="text"] {
                width: 120px; /* Increased from 100px */
            }
            th, td {
                padding: 12px; /* Increased from 6px for mobile */
                font-size: 14px; /* Slightly larger on mobile */
            }
            button {
                padding: 12px 20px; /* Scaled down but still larger than original */
                font-size: 16px; /* Scaled down */
                min-width: 100px; /* Adjusted for mobile */
            }
            .remove-btn {
                padding: 6px 12px; /* Scaled for mobile */
                font-size: 14px;
            }
            .small-btn {
                padding: 10px 18px; /* Scaled for mobile */
                font-size: 16px;
            }
            .nav-menu {
                position: fixed;
                left: -100%;
                top: 60px;
                flex-direction: column;
                background-color: #2c3e50;
                width: 100%;
                text-align: center;
                transition: left 0.3s ease; /* Smoother transition */
                padding: 20px 0;
                z-index: 99; /* Below profile dropdown */
            }
            .nav-menu.active {
                left: 0;
            }
            .hamburger {
                display: flex;
            }
            .nav-profile {
                margin-left: auto;
            }
            /* NEW: Landscape mobile fix for table overflow */
            @media (max-width: 768px) and (orientation: landscape) {
                .container { padding: 10px; }
                th, td { padding: 8px; font-size: 12px; }
                input[type="number"], input[type="text"] { width: 60px; padding: 6px; font-size: 14px; }
            }
        }
        /* Help section styling */
        .help-section {
            padding: 20px 0;
        }
        .help-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .help-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .help-card h2 {
            background: #3498db;
            color: white;
            padding: 15px;
            margin: 0;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .help-card h2:hover {
            background: #2980b9;
        }
        .accordion-content {
            display: none;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .accordion-content.active {
            display: block;
        }
        .accordion-content ol, .accordion-content ul, .accordion-content dl {
            padding-left: 20px;
        }
        .accordion-content a {
            color: #3498db;
            text-decoration: none;
        }
        .accordion-content a:hover {
            text-decoration: underline;
        }
        .back-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px; /* Matches global button increase */
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px; /* Matches global */
            margin-top: 20px;
            display: block;
            margin-left: auto;
        }
        .back-btn:hover {
            background-color: #229954;
        }
        /* Smooth transitions for sections */
        section {
            transition: opacity 0.3s ease;
            opacity: 1;
        }
        /* Settings section styling */
        .settings-section {
            padding: 20px 0;
        }
        .settings-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .setting-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }
        .setting-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .setting-card p {
            margin: 5px 0;
            color: #666;
        }
        .setting-card input[type="number"], .setting-card input[type="text"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 10px;
        }
        .small-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px; /* Increased from 5px 10px */
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px; /* Increased from 14px */
        }
        .small-btn:hover {
            background-color: #2980b9;
        }
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px; /* Matches global increase */
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px; /* Matches global */
            width: 100%;
        }
        .clear-btn:hover {
            background-color: #c0392b;
        }
        .small-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        /* Toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 10px 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #27ae60;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        /* Dark mode overrides */
        body.dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        body.dark-mode .container {
            background: #34495e;
            color: #ecf0f1;
        }
        body.dark-mode table th {
            background-color: #1a252f;
        }
        body.dark-mode .help-card, body.dark-mode .setting-card, body.dark-mode .profile-card, body.dark-mode .contact-card {
            background: #3d566e;
            border-color: #5a6c7d;
        }
        body.dark-mode .result { background-color: #1e3a2f; color: #a3e4d7; }
        body.dark-mode .error { color: #ff6b6b; }
        body.dark-mode .average-cell { background-color: #2d4a3a; color: #a3e4d7; }
        body.dark-mode .period-avg-row { background-color: #1e3a2f; }
        body.dark-mode input { background-color: #3d566e; border-color: #5a6c7d; color: #ecf0f1; }
        body.dark-mode textarea { background-color: #3d566e; border-color: #5a6c7d; color: #ecf0f1; }
        body.dark-mode input::placeholder { color: #a0a0a0; opacity: 0.7; } /* Added for better dark mode placeholder visibility */
        /* Footer styling */
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            margin-top: 20px;
        }
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            margin: 0 10px;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
        /* Profile section styling */
        .profile-section {
            padding: 20px 0;
        }
        .profile-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .profile-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }
        .profile-pic-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px 0;
            border: 2px solid #3498db;
        }
        .session-list {
            list-style: none;
            padding: 0;
        }
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        .session-item button {
            padding: 8px 15px; /* Increased to match remove-btn */
            font-size: 16px; /* Increased */
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-item {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        /* Auth form styling */
        .auth-form {
            display: grid;
            gap: 10px;
            max-width: 300px;
        }
        .auth-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 10px;
        }
        .auth-toggle button {
            background: none;
            color: #3498db;
            border: none;
            cursor: pointer;
            text-decoration: underline;
        }
        .auth-error {
            color: #e74c3c;
            font-size: 14px;
            text-align: center;
        }
        /* Contact section styling */
        .contact-section {
            padding: 20px 0;
        }
        .contact-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .contact-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }
        .contact-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .contact-form {
            display: grid;
            gap: 10px;
        }
        .contact-form label {
            font-weight: bold;
        }
        .contact-form input, .contact-form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .contact-form textarea {
            height: 100px;
            resize: vertical;
        }
        .contact-info ul {
            list-style: none;
            padding: 0;
        }
        .contact-info li {
            margin: 10px 0;
        }
        .contact-info a {
            color: #3498db;
            text-decoration: none;
        }
        .contact-info a:hover {
            text-decoration: underline;
        }
        .quick-links ul {
            list-style: none;
            padding: 0;
        }
        .quick-links li {
            margin: 5px 0;
        }
        .quick-links a {
            color: #3498db;
            text-decoration: none;
        }
        .quick-links a:hover {
            text-decoration: underline;
        }
        .submit-btn {
            background-color: #27ae60;
            padding: 15px 30px; /* Matches global increase */
            font-size: 18px; /* Matches global */
        }
        .submit-btn:hover {
            background-color: #229954;
        }
        /* Hide/show classes for auth */
        .auth-section { display: none; }
        .auth-section.active { display: block; }
        .profile-info { display: none; }
        .profile-info.active { display: block; }
        /* NEW: AI Assistant styling */
        .ai-section {
            padding: 20px 0;
        }
        .ai-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .ai-chat-container {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 500px;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: white;
        }
        .ai-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
        }
        .ai-message.user {
            background: #3498db;
            color: white;
            text-align: right;
        }
        .ai-message.ai {
            background: #e8f4fd;
            color: #2c3e50;
        }
        .ai-message .retry-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        .ai-message .retry-btn:hover {
            background: #229954;
        }
        .ai-chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        .ai-chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
        }
        .ai-chat-input button {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }
        .ai-chat-input button:hover {
            background: #229954;
        }
        .ai-status {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        /* NEW: Floating AI Chat Widget - UPDATED FOR IMAGE ICON */
        .floating-chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3498db, #27ae60);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            /* REMOVED: font-size and color (no longer needed for emoji) */
        }
        .floating-chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        .floating-chat-toggle img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        .floating-chat-toggle:hover img {
            opacity: 1; /* Brighten image on hover */
        }
        .floating-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 199;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ddd;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .floating-chat-window.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        .floating-chat-header {
            background: #3498db;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .floating-chat-header h4 {
            margin: 0;
            font-size: 16px;
        }
        .floating-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .floating-chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .floating-chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: white;
        }
        .floating-chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        .floating-chat-input button {
            padding: 8px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 14px;
        }
        .floating-chat-input button:hover {
            background: #229954;
        }
        .floating-chat-status {
            font-size: 12px;
            text-align: center;
            padding: 5px;
            color: #666;
            background: #f8f9fa;
        }
        .floating-chat-full-link {
            text-align: center;
            padding: 5px;
            font-size: 12px;
        }
        .floating-chat-full-link a {
            color: #3498db;
            text-decoration: none;
        }
        .floating-chat-full-link a:hover {
            text-decoration: underline;
        }
        /* Mobile adjustments for floating chat */
        @media (max-width: 768px) {
            .floating-chat-toggle {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }
            .floating-chat-window {
                width: calc(100vw - 30px);
                height: 80vh;
                bottom: 70px;
                right: 15px;
            }
            .floating-chat-header h4 {
                font-size: 14px;
            }
        }
        /* Dark mode for floating chat */
        body.dark-mode .floating-chat-window {
            background: #34495e;
            border-color: #5a6c7d;
            color: #ecf0f1;
        }
        body.dark-mode .floating-chat-messages {
            background: #3d566e;
        }
        body.dark-mode .floating-chat-input {
            background: #34495e;
        }
        body.dark-mode .floating-chat-input input {
            background: #3d566e;
            border-color: #5a6c7d;
            color: #ecf0f1;
        }
        body.dark-mode .floating-chat-status {
            color: #a0a0a0;
            background: #3d566e;
        }
    </style>
</head>
<body>
    <!-- Fixed nav moved outside container -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="#" onclick="showSection('grades')">Grade Calculator</a>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="#" onclick="showSection('grades')">Grades</a></li>
                <li><a href="#" onclick="showSection('profile')">Profile</a></li>
                <li><a href="#" onclick="showSection('settings')">Settings</a></li>
                <li><a href="#" onclick="showSection('help')">Help</a></li>
                <li><a href="#" onclick="showSection('contact')">Contact</a></li>
            </ul>
            <div class="nav-profile">
                <img id="navProfilePic" src="Suahco4.png" alt="User profile avatar" class="profile-pic" onclick="toggleProfileMenu()">
                <!-- Profile dropdown - INITIALIZED TO GUEST STATE -->
                <div id="profileDropdown" class="profile-dropdown">
                    <a href="#" onclick="showSection('profile')">Login</a>
                </div>
            </div>
            <div class="hamburger" onclick="toggleNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- UPDATED: Floating AI Chat Toggle Button - NOW WITH suahco4.png IMAGE -->
    <button class="floating-chat-toggle" onclick="toggleFloatingChat()" title="Chat with AI Assistant">
        <img src="Suahco4.png" alt="AI Assistant">
    </button>

    <!-- NEW: Floating AI Chat Window -->
    <div id="floatingChatWindow" class="floating-chat-window">
        <div class="floating-chat-header">
            <h4>Suahco4 Assistant</h4>
            <button class="floating-chat-close" onclick="toggleFloatingChat()">&times;</button>
        </div>
        <div id="floatingChatMessages" class="floating-chat-messages">
            <div class="ai-message ai">Hi! I'm your AI assistant. Ask me about your grades, study advice, or tool tips. For example: "How do I improve my Math score?"</div>
        </div>
        <div class="floating-chat-input">
            <input type="text" id="floatingChatInput" placeholder="Type your question..." onkeypress="handleFloatingKeyPress(event)">
            <button onclick="sendMessageToFloatingAI()">Send</button>
        </div>
        <div id="floatingChatStatus" class="floating-chat-status"></div>
        <div class="floating-chat-full-link">
            <a href="#" onclick="showSection('ai'); toggleFloatingChat();">Open Full Chat ‚Üí</a>
        </div>
    </div>

    <div class="container">
        <!-- Wrapped: Grades Section -->
        <section id="grades-section" class="grades-section">
            <div class="controls">
                <button id="addSubject">Add Subject</button>
                <button id="calculate">Calculate Averages</button>
                <!-- Download buttons (hidden initially) -->
                <div>
                    <button id="downloadBtn" style="display: none; background-color: #f39c12;" onclick="downloadCSV()">Download CSV</button>
                    <button id="pdfBtn" style="display: none; background-color: #9b59b6;" onclick="downloadPDF()">Download PDF</button>
                </div>
            </div>
            
            <table id="gradeTable">
                <thead>
                    <tr>
                        <th class="subject-th">Subject</th>
                        <th>1st Period</th>
                        <th>2nd Period</th>
                        <th>3rd Period</th>
                        <th>Exam 1</th>
                        <th>4th Period</th>
                        <th>5th Period</th>
                        <th>6th Period</th>
                        <th>Final</th>
                        <th>Subject Average</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic rows will be added here -->
                </tbody>
                <tfoot>
                    <tr class="period-avg-row" id="periodAvgRow">
                        <td><strong>Period Averages</strong></td>
                        <td id="avg1">0.00</td>
                        <td id="avg2">0.00</td>
                        <td id="avg3">0.00</td>
                        <td id="avgExam1">0.00</td>
                        <td id="avg4">0.00</td>
                        <td id="avg5">0.00</td>
                        <td id="avg6">0.00</td>
                        <td id="avgExam2">0.00</td>
                        <td class="overall-average" id="overallAverage">0.00</td>
                    </tr>
                </tfoot>
            </table>
            
            <div id="result"></div>
            <div id="error" class="error"></div>
        </section>

        <!-- UPDATED: AI Assistant Section (now hidden by default, accessible via floating chat) -->
        <section id="ai-section" class="ai-section" style="display: none;">
            <h1>ü§ñ AI Assistant</h1>
            <div class="ai-content">
                <p style="text-align: center; color: #666;">Ask me anything about grades, study tips, or how to use this tool! (Powered by OpenAI)</p>
                <div class="ai-chat-container">
                    <div id="aiChatMessages" class="ai-chat-messages">
                        <div class="ai-message ai">Hi! I'm your AI assistant. Ask me about your grades, study advice, or tool tips. For example: "How do I improve my Math score?"</div>
                    </div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiChatInput" placeholder="Type your question..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessageToAI()">Send</button>
                    </div>
                </div>
                <div id="aiStatus" class="ai-status"></div>
                <p style="text-align: center; font-size: 12px; color: #999;">Note: Your chats are sent to OpenAI for processing. No data is stored.</p>
            </div>
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Help Section (hidden by default) -->
        <section id="help-section" class="help-section" style="display: none;">
            <h1>Help & Guide</h1>
            
            <div class="help-content">
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üìñ Introduction</h2>
                    <div class="accordion-content">
                        <p>Welcome to <strong>Grade Matrix Calculator</strong>! This tool helps you track grades across periods and exams, calculate subject/period averages, and export reports. It's designed for students and teachers‚Äîsimple, fast, and mobile-friendly.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üöÄ How to Use</h2>
                    <div class="accordion-content">
                        <ol>
                            <li><strong>Add Subjects</strong>: Click "Add Subject" or use the pre-loaded ones (e.g., Mathematics). Edit names as needed.</li>
                            <li><strong>Enter Scores</strong>: Fill in numbers (0-100) for each period/exam. Scores below 70 auto-highlight in red!</li>
                            <li><strong>Calculate</strong>: Click "Calculate Averages" (<em>Pro Tip: Ctrl+Enter shortcut!</em>) to compute subject averages, period averages, and overall grade.</li>
                            <li><strong>Download</strong>: After calculating, use "Download CSV" (for Excel) or "Download PDF" (for printing). Files include only periods with data.</li>
                            <li><strong>Remove Rows</strong>: Click "Remove" next to any subject.</li>
                        </ol>
                        <p><em>Tip:</em> Empty scores are skipped in averages. Save your work‚Äîdata persists until page refresh.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">‚ú® Features</h2>
                    <div class="accordion-content">
                        <ul>
                            <li><strong>Real-Time Highlights</strong>: Low scores (&lt;70) turn red instantly.</li>
                            <li><strong>Dynamic Table</strong>: Add/remove subjects on-the-fly; sticky headers for scrolling.</li>
                            <li><strong>Averages</strong>: Subject (per row), Period (columns), Overall (grand).</li>
                            <li><strong>Exports</strong>: CSV for data analysis; PDF for reports (landscape format, filtered to entered periods).</li>
                            <li><strong>Responsive</strong>: Works on phone/tablet with hamburger menu.</li>
                            <li><strong>Validation</strong>: Errors shown for invalid inputs (e.g., non-numbers).</li>
                        </ul>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîß Troubleshooting</h2>
                    <div class="accordion-content">
                        <dl>
                            <dt>No averages showing?</dt>
                            <dd>Enter at least one score per subject and click "Calculate".</dd>
                            
                            <dt>Download not working?</dt>
                            <dd>Ensure you've calculated first. Check browser pop-up blockers.</dd>
                            
                            <dt>Mobile issues?</dt>
                            <dd>Horizontal scroll for wide table; tap hamburger (‚ò∞) for nav.</dd>
                            
                            <dt>Red highlights not clearing?</dt>
                            <dd>Edit score to 70+ or clear it‚Äîupdates live.</dd>
                        </dl>
                        <p>If issues persist, refresh the page or check console (F12).</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üìß Contact & More</h2>
                    <div class="accordion-content">
                        <p>Questions? Use the <a href="#" onclick="showSection('contact')">Contact Form</a> or email <a href="mailto:mr.suah19@gmail.com">mr.suah19@gmail.com</a>.</p>
                        <p><em>Last updated:</em> October 5, 2025</p>
                    </div>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Settings Section (hidden by default) -->
        <section id="settings-section" class="settings-section" style="display: none;">
            <h1>Settings</h1>
            
            <div class="settings-content">
                <div class="setting-card">
                    <h3>üåô Theme</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                        <span class="toggle-slider"></span>
                        Dark Mode
                    </label>
                </div>
                
                <div class="setting-card">
                    <h3>‚ö†Ô∏è Low Score Threshold</h3>
                    <p>Highlight scores below this value in red (current: <span id="currentThreshold">70</span>).</p>
                    <input type="number" id="thresholdInput" value="70" min="0" max="100" onchange="updateThreshold()">
                    <button onclick="applyThreshold()" class="small-btn">Apply</button>
                </div>
                
                <!-- NEW: GPA Toggle -->
                <div class="setting-card">
                    <h3>üìä GPA Mode</h3>
                    <p>Switch between percentage (%) and GPA (4.0 scale) for calculations.</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gpaToggle" onchange="toggleGPAScale()">
                        <span class="toggle-slider"></span>
                        Enable GPA (4.0)
                    </label>
                </div>
                
                <div class="setting-card">
                    <h3>üìö Default Subjects</h3>
                    <p>Comma-separated list (loads on page refresh).</p>
                    <input type="text" id="defaultSubjectsInput" value="Mathematics,English,Science,History" placeholder="e.g., Math,English,Physics">
                    <button onclick="saveDefaultSubjects()" class="small-btn">Save</button>
                </div>
                
                <div class="setting-card">
                    <h3>üì§ Export Options</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dateInFilename" checked onchange="toggleDateInExport()">
                        <span class="toggle-slider"></span>
                        Include Date in Filenames
                    </label>
                </div>
                
                <div class="setting-card">
                    <h3>üóëÔ∏è Data Management</h3>
                    <button onclick="clearAllData()" class="clear-btn">Clear All Data & Reset</button>
                    <p class="small-text">Resets table to default subjects (no score loss if saved externally).</p>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Profile Section (hidden by default) -->
        <section id="profile-section" class="profile-section" style="display: none;">
            <h1>Profile</h1>
            
            <div class="profile-content">
                <!-- Auth Section (shown if not logged in) -->
                <div id="authSection" class="profile-card auth-section active">
                    <h3>üë§ Sign Up / Login</h3>
                    <form class="auth-form" id="authForm">
                        <input type="text" id="signupName" placeholder="Full Name (optional)">
                        <input type="email" id="authEmail" placeholder="Email" required>
                        <input type="password" id="authPassword" placeholder="Password" required>
                        <button type="submit" id="authSubmit" class="small-btn">Sign Up</button>
                    </form>
                    <div class="auth-toggle">
                        <button type="button" id="toggleAuth" class="auth-toggle-btn">Or Login Instead</button>
                    </div>
                    <div id="authError" class="auth-error"></div>
                </div>

                <!-- Profile Info (shown if logged in) -->
                <div id="profileInfo" class="profile-info">
                    <div class="profile-card">
                        <h3>üë§ User Information</h3>
                        <img id="profilePicPreview" src="Suahco4.png" alt="User profile picture preview" class="profile-pic-preview">
                        <input type="file" id="profilePicUpload" accept="image/*" onchange="handlePicUpload(event)" style="display: none;">
                        <p><label>Name: <input type="text" id="userName" placeholder="Your Name"></label></p>
                        <p><label>Email: <input type="email" id="userEmail" placeholder="your@email.com" disabled></label></p>
                        <button onclick="saveProfile()" class="small-btn">Save Profile</button>
                    </div>
                    
                    <div class="profile-card">
                        <h3>üíæ Saved Sessions</h3>
                        <p>Save your current grades to load later.</p>
                        <button onclick="saveSession()" class="small-btn">Save Current Session</button>
                        <ul id="sessionList" class="session-list"></ul>
                    </div>
                    
                    <div class="profile-card">
                        <h3>üìä Quick Stats</h3>
                        <div id="statsGrid" class="stats-grid">
                            <!-- Stats populated dynamically -->
                        </div>
                        <button onclick="generateStats()" class="small-btn">Refresh Stats</button>
                    </div>
                    
                    <div class="profile-card">
                        <h3>üö™ Account Actions</h3>
                        <button onclick="logout()" class="clear-btn">Logout</button>
                        <p class="small-text">Clears session and logs you out.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Contact Section (hidden by default) -->
        <section id="contact-section" class="contact-section" style="display: none;">
            <h1>Contact Us</h1>
            
            <div class="contact-content">
                <div class="contact-card">
                    <h3>üìù Send Us a Message</h3>
                    <form class="contact-form" id="contactForm">
                        <label for="contactName">Name:</label>
                        <input type="text" id="contactName" required>
                        
                        <label for="contactEmail">Email:</label>
                        <input type="email" id="contactEmail" required>
                        
                        <label for="contactSubject">Subject:</label>
                        <input type="text" id="contactSubject" required>
                        
                        <label for="contactMessage">Message:</label>
                        <textarea id="contactMessage" required></textarea>
                        
                        <button type="submit" class="submit-btn">Send Message</button>
                    </form>
                </div>
                
                <div class="contact-card">
                    <h3>üìû Direct Contact</h3>
                    <div class="contact-info">
                        <ul>
                            <li><strong>Email:</strong> <a href="mailto:mr.suah19@gmail.com">Support Team</a></li>
                            <li><strong>Phone:</strong> <a href="tel:0778662590">+231 (778) 662-590</a></li>
                        </ul>
                        <p class="small-text">We respond within 24-48 hours!</p>
                    </div>
                </div>
                
                <div class="contact-card">
                    <h3>üîó Quick Links</h3>
                    <div class="quick-links">
                        <ul>
                            <li><a href="#" onclick="showSection('help')">Help & FAQ</a></li>
                            <li><a href="#" onclick="showSection('profile')">My Profile</a></li>
                            <li><a href="#" onclick="showSection('settings')">App Settings</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Privacy Policy Section (hidden by default) -->
        <section id="privacy-section" class="help-section" style="display: none;">
            <h1>Privacy Policy</h1>
            
            <div class="help-content">
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üìú Introduction</h2>
                    <div class="accordion-content active">
                        <p>Effective Date: October 5, 2025</p>
                        <p>Welcome to Grade Calculator ("we," "our," or "us"). We respect your privacy and are committed to protecting your personal information. This Privacy Policy explains how we collect, use, disclose, and safeguard your data when you use our web application (the "App"). By using the App, you consent to these practices.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîç Information We Collect</h2>
                    <div class="accordion-content">
                        <p>We collect the following types of information:</p>
                        <ul>
                            <li><strong>Personal Data</strong>: Email address, name, and profile photo (if provided) during registration/login via Firebase Authentication.</li>
                            <li><strong>Usage Data</strong>: Grades, subjects, and session data stored locally in your browser (localStorage). This is not sent to our servers unless you explicitly save sessions.</li>
                            <li><strong>Contact Data</strong>: Name, email, subject, and message when using the contact form.</li>
                        </ul>
                        <p>We do <em>not</em> collect sensitive data like financial info or health records.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üì§ How We Use Your Information</h2>
                    <div class="accordion-content">
                        <ul>
                            <li>Provide and improve App features (e.g., save sessions, calculate grades).</li>
                            <li>Send auto-replies and respond to contact form inquiries via EmailJS.</li>
                            <li>Analyze usage to enhance the App.</li>
                        </ul>
                        <p>We do not sell your data to third parties.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîí Data Security & Storage</h2>
                    <div class="accordion-content">
                        <p>Your data is secured with:</p>
                        <ul>
                            <li>Firebase Authentication (encrypted, compliant with GDPR/CCPA).</li>
                            <li>Local browser storage for grades/sessions (deleted on logout/clear).</li>
                            <li>EmailJS for contact forms (data transmitted securely, not stored long-term).</li>
                        </ul>
                        <p>We retain data only as long as needed for App functionality. You can delete your account via Firebase console or contact us.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üåê Third-Party Services</h2>
                    <div class="accordion-content">
                        <ul>
                            <li><strong>Firebase</strong>: For authentication and user management (see <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Google Privacy Policy</a>).</li>
                            <li><strong>EmailJS</strong>: For contact form submissions (see <a href="https://www.emailjs.com/legal/privacy-policy/" target="_blank" rel="noopener">EmailJS Privacy Policy</a>).</li>
                            <li><strong>jsPDF</strong>: Local PDF generation (no data sent externally; open-source library).</li>
                        </ul>
                        <p>We only share data with these services as necessary for functionality. No ads or tracking pixels.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">‚öñÔ∏è Your Rights & Choices</h2>
                    <div class="accordion-content">
                        <p>You have rights to:</p>
                        <ul>
                            <li>Access, update, or delete your data (via Profile or contact us).</li>
                            <li>Opt-out of communications (reply "unsubscribe" to emails).</li>
                            <li>Withdraw consent (logout/delete account).</li>
                        </ul>
                        <p>For EU users: GDPR compliant. For CA users: CCPA compliant. Contact us for requests.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîÑ Changes to This Policy</h2>
                    <div class="accordion-content">
                        <p>We may update this policy. Changes will be posted here with the new effective date. Continued use after changes implies acceptance.</p>
                        <p>Questions? Email <a href="mailto:mr.suah19@gmail.com">mr.suah19@gmail.com</a>.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>

        <!-- Terms of Service Section (hidden by default) -->
        <section id="terms-section" class="help-section" style="display: none;">
            <h1>Terms of Service</h1>
            
            <div class="help-content">
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üìú Introduction</h2>
                    <div class="accordion-content active">
                        <p>Effective Date: October 5, 2025</p>
                        <p>Welcome to Grade Calculator ("we," "our," or "us"). These Terms of Service ("Terms") govern your use of our web application (the "App"). By accessing or using the App, you agree to be bound by these Terms. If you do not agree, please do not use the App.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üë§ User Responsibilities</h2>
                    <div class="accordion-content">
                        <p>You agree to:</p>
                        <ul>
                            <li>Use the App only for lawful purposes and in compliance with all applicable laws.</li>
                            <li>Provide accurate information during registration and use.</li>
                            <li>Not misuse the App, including but not limited to: introducing malware, unauthorized access, or spamming.</li>
                            <li>Respect intellectual property rights and not copy or distribute App content without permission.</li>
                        </ul>
                        <p>We reserve the right to suspend or terminate accounts for violations.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üí° Intellectual Property</h2>
                    <div class="accordion-content">
                        <p>The App and its content (including design, code, and features) are owned by us or our licensors. You are granted a limited, non-exclusive, non-transferable license to use the App for personal, non-commercial purposes. You may not modify, reproduce, or distribute any part of the App without written consent.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üö´ Disclaimers & Limitations</h2>
                    <div class="accordion-content">
                        <p>The App is provided "as is" without warranties of any kind. We do not guarantee accuracy of calculations or uninterrupted service. You use the App at your own risk. In no event shall we be liable for indirect, incidental, or consequential damages arising from your use of the App.</p>
                        <p>Liability is limited to the maximum extent permitted by law.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîö Termination</h2>
                    <div class="accordion-content">
                        <p>We may terminate or suspend your access to the App at any time, with or without notice, for any reason, including violations of these Terms. Upon termination, your right to use the App ceases immediately.</p>
                        <p>You may stop using the App at any time by deleting your account or ceasing access.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">‚öñÔ∏è Governing Law</h2>
                    <div class="accordion-content">
                        <p>These Terms are governed by the laws of Liberia, without regard to conflict of law principles. Any disputes shall be resolved exclusively in the courts of Monrovia, Liberia.</p>
                    </div>
                </div>
                
                <div class="help-card">
                    <h2 onclick="toggleAccordion(this)">üîÑ Changes to These Terms</h2>
                    <div class="accordion-content">
                        <p>We may update these Terms from time to time. Changes will be posted here with the new effective date. Continued use of the App after changes constitutes acceptance.</p>
                        <p>Questions? Email <a href="mailto:mr.suah19@gmail.com">mr.suah19@gmail.com</a>.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="showSection('grades')" class="back-btn">‚Üê Back to Grades</button>
        </section>
    </div>

    <footer>
        <div class="footer-container">
            <p>&copy; 2025 Grade Calculator. All rights reserved. Last updated October 2025.</p>
            <p>Developed with ‚ù§Ô∏è for students everywhere.</p>
            <div class="footer-links">
                <a href="#" onclick="showSection('privacy')">Privacy Policy</a>
                <a href="#" onclick="showSection('terms')">Terms of Service</a>
                <a href="#" onclick="showSection('contact')">Contact Us</a>
            </div>
        </div>
    </footer>

    <script>
        let subjectCount = 0;
        const numScoreColumns = 8; // 1st,2nd,3rd,Exam1,4th,5th,6th,Exam2
        const columnIdMap = ['avg1', 'avg2', 'avg3', 'avgExam1', 'avg4', 'avg5', 'avg6', 'avgExam2'];
        let currentThreshold = 70;
        let activeColumns = []; // Tracks columns with data (indices)
        let columnNames = ['1st Period', '2nd Period', '3rd Period', 'Exam 1', '4th Period', '5th Period', '6th Period', 'Final']; // For labeling
        let lastOverallAvg = '0.00'; // For stats
        let lastSubjectAvgs = []; // For stats
        let currentUser = null; // Firebase user
        let isGPAMode = false; // NEW: GPA toggle state

        // REMOVED: Hardcoded OpenAI key - now handled via Vercel proxy (/api/openai)
        // Ensure you have /api/openai.js deployed on Vercel with OPENAI_API_KEY env var

        // NEW: Debounce utility for input events
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // NEW: Letter grade mapping
        function getLetterGrade(avg) {
            const numAvg = parseFloat(avg);
            if (numAvg >= 90) return 'A';
            if (numAvg >= 80) return 'B';
            if (numAvg >= 70) return 'C';
            if (numAvg >= 60) return 'D';
            return 'F';
        }

        // UPDATED: Retry last message (for AI errors) - now handles both chat types
        let lastUserMessage = '';
        function retryLastMessage(chatType = 'full') {  // Default to full chat
            if (lastUserMessage) {
                const input = chatType === 'floating' ? 
                    document.getElementById('floatingChatInput') : 
                    document.getElementById('aiChatInput');
                if (input) {
                    input.value = lastUserMessage;
                    if (chatType === 'floating') {
                        sendMessageToFloatingAI();
                    } else {
                        sendMessageToAI();
                    }
                }
            }
        }

        // UPDATED: AI Chat Functions (now proxies through Vercel /api/openai)
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessageToAI();
        }

        // NEW: Floating chat keypress handler
        function handleFloatingKeyPress(e) {
            if (e.key === 'Enter') sendMessageToFloatingAI();
        }

        async function sendMessageToAI() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;

            lastUserMessage = message; // For retry

            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            showAIStatus('ü§î Thinking...', 'loading');

            // NEW: Pass grades context for smarter replies
            const context = lastSubjectAvgs.length > 0 ? 
                `Current grades: Overall ${lastOverallAvg}%. Subjects: ${lastSubjectAvgs.map(s => `${s.name}: ${s.avg}%`).join('; ')}.` : 
                'No grades calculated yet.';

            try {
                const response = await fetch('/api/openai', {  // Vercel proxy endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful AI assistant for the Grade Calculator tool. Provide concise, friendly advice on grades, study tips, GPA calculation, or tool usage. Keep responses under 150 words. Be encouraging!'
                            },
                            { role: 'user', content: `${context} User query: ${message}` }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('AI service not available‚Äîcheck deployment.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error ${response.status}`);
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;
                addMessageToChat(aiReply, 'ai');
                showAIStatus('‚úÖ Sent!', 'success');
            } catch (error) {
                console.error('AI Error:', error);
                const errorMsg = error.message.includes('not configured') ? '‚ùå API key not set on server. Contact admin.' :
                                 error.message.includes('401') ? '‚ùå Invalid API key‚Äîcheck server config.' :
                                 error.message.includes('429') ? '‚è≥ Rate limit hit. Try again in a minute.' :
                                 '‚ùå Connection issue. Check internet or try again.';
                const fallbackMsg = 'AI is taking a break. Try: Focus on weak subjects for quick wins!';
                showAIStatus(errorMsg, 'error');
                addMessageToChat(`Sorry! ${errorMsg}. ${fallbackMsg} <button class="retry-btn" onclick="retryLastMessage()">Retry</button>`, 'ai');
            }
        }

        // UPDATED: Send message for floating chat (proxies through Vercel)
        async function sendMessageToFloatingAI() {
            const input = document.getElementById('floatingChatInput');
            const message = input.value.trim();
            if (!message) return;

            lastUserMessage = message; // For retry

            // Add user message to floating chat
            addMessageToFloatingChat(message, 'user');
            input.value = '';
            showFloatingAIStatus('ü§î Thinking...', 'loading');

            // NEW: Pass grades context for smarter replies
            const context = lastSubjectAvgs.length > 0 ? 
                `Current grades: Overall ${lastOverallAvg}%. Subjects: ${lastSubjectAvgs.map(s => `${s.name}: ${s.avg}%`).join('; ')}.` : 
                'No grades calculated yet.';

            try {
                const response = await fetch('/api/openai', {  // Vercel proxy endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful AI assistant for the Grade Calculator tool. Provide concise, friendly advice on grades, study tips, GPA calculation, or tool usage. Keep responses under 150 words. Be encouraging!'
                            },
                            { role: 'user', content: `${context} User query: ${message}` }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('AI service not available‚Äîcheck deployment.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error ${response.status}`);
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;
                addMessageToFloatingChat(aiReply, 'ai');
                showFloatingAIStatus('‚úÖ Sent!', 'success');
            } catch (error) {
                console.error('AI Error:', error);
                const errorMsg = error.message.includes('not configured') ? '‚ùå API key not set on server. Contact admin.' :
                                 error.message.includes('401') ? '‚ùå Invalid API key‚Äîcheck server config.' :
                                 error.message.includes('429') ? '‚è≥ Rate limit hit. Try again in a minute.' :
                                 '‚ùå Connection issue. Check internet or try again.';
                const fallbackMsg = 'AI is taking a break. Try: Focus on weak subjects for quick wins!';
                showFloatingAIStatus(errorMsg, 'error');
                // UPDATED: Pass 'floating' to retry function
                addMessageToFloatingChat(`Sorry! ${errorMsg}. ${fallbackMsg} <button class="retry-btn" onclick="retryLastMessage('floating')">Retry</button>`, 'ai');
            }
        }

        function addMessageToChat(message, sender) {
            const messagesDiv = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = message;  // Use innerHTML for retry button
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // NEW: Add message to floating chat
        function addMessageToFloatingChat(message, sender) {
            const messagesDiv = document.getElementById('floatingChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.innerHTML = message;  // Use innerHTML for retry button
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showAIStatus(message, type) {
            const statusDiv = document.getElementById('aiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `ai-status ${type}`;
            if (type !== 'loading') {
                setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = 'ai-status'; }, 3000);
            }
        }

        // NEW: Show status for floating chat
        function showFloatingAIStatus(message, type) {
            const statusDiv = document.getElementById('floatingChatStatus');
            statusDiv.textContent = message;
            statusDiv.className = `floating-chat-status ${type}`;
            if (type !== 'loading') {
                setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = 'floating-chat-status'; }, 3000);
            }
        }

        // NEW: Toggle floating chat window
        function toggleFloatingChat() {
            const window = document.getElementById('floatingChatWindow');
            window.classList.toggle('active');
            if (window.classList.contains('active')) {
                document.getElementById('floatingChatInput').focus();
            }
        }

        // NEW: Close floating chat on outside click or Escape
        document.addEventListener('click', function(e) {
            const window = document.getElementById('floatingChatWindow');
            const toggleBtn = document.querySelector('.floating-chat-toggle');
            if (window.classList.contains('active') && !window.contains(e.target) && !toggleBtn.contains(e.target)) {
                window.classList.remove('active');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const window = document.getElementById('floatingChatWindow');
                if (window.classList.contains('active')) {
                    window.classList.remove('active');
                }
            }
        });

        // JS Fallback for www redirect (uncomment if no custom domain)
        /*
        if (window.location.hostname === 'www.suahco4.github.io') {
            window.location.replace('https://suahco4.github.io' + window.location.pathname);
        }
        */

        // Dynamic Meta Updates for SEO
        function updateMetaForSection(section) {
            const titles = {
                'grades': 'Grade Calculator | Free Online GPA & Average Tool with PDF/CSV Export',
                'help': 'Help & Guide | Grade Calculator - Free GPA Tool',
                'settings': 'Settings | Grade Calculator - Customize Your Experience',
                'profile': 'Profile | Grade Calculator - Manage Account & Sessions',
                'contact': 'Contact Us | Grade Calculator - Get Support',
                'ai': 'AI Assistant | Grade Calculator - Smart Study Help', // NEW
                'privacy': 'Privacy Policy | Grade Calculator - Data Protection',
                'terms': 'Terms of Service | Grade Calculator - User Agreement'
            };
            document.title = titles[section] || 'Grade Calculator | Free Online GPA Tool';
            
            // Update meta description
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                const descriptions = {
                    'grades': 'Track grades across periods & exams with our free Grade Matrix Calculator. Calculate averages, export PDF/CSV, save sessions. Mobile-friendly & secure.',
                    'help': 'Learn to use Grade Calculator: add subjects, calculate averages, export reports. Free GPA tool for students.',
                    'ai': 'Chat with our AI assistant for grade advice, study tips, and tool help.', // NEW
                    'contact': 'Contact Grade Calculator team for support on our free GPA tool.',
                    'privacy': 'Grade Calculator Privacy Policy: how we protect your data.',
                    'terms': 'Grade Calculator Terms of Service: rules for using our free grading tool.'
                };
                metaDesc.setAttribute('content', descriptions[section] || 'Track grades across periods & exams with our free Grade Matrix Calculator. Calculate averages, export PDF/CSV, save sessions. Mobile-friendly & secure.');
            }
        }

        // Firebase Auth Functions
        function signUpWithEmail(email, password, name) {
            const { createUserWithEmailAndPassword, updateProfile } = window;
            const auth = window.auth;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return updateProfile(user, { displayName: name });
                })
                .then(() => {
                    alert('Account created successfully! You are now logged in.');
                    document.getElementById('authForm').reset();
                    document.getElementById('authError').textContent = '';
                    loadProfile();
                    closeMobileNav(); // NEW: Close nav after auth
                })
                .catch((error) => {
                    console.error('Sign Up Error:', error);
                    document.getElementById('authError').textContent = error.message;
                });
        }

        function signInWithEmail(email, password) {
            const { signInWithEmailAndPassword } = window;
            const auth = window.auth;
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    alert('Logged in successfully!');
                    document.getElementById('authForm').reset();
                    document.getElementById('authError').textContent = '';
                    loadProfile();
                    closeMobileNav(); // NEW: Close nav after auth
                })
                .catch((error) => {
                    console.error('Sign In Error:', error);
                    document.getElementById('authError').textContent = error.message;
                });
        }

        function signOutUser() {
            const { signOut } = window;
            const auth = window.auth;
            signOut(auth).then(() => {
                alert('Logged out successfully!');
                currentUser = null;
                updateAuthUI();
                showSection('grades');
                closeMobileNav(); // NEW: Close nav after logout
            }).catch((error) => {
                console.error('Sign Out Error:', error);
            });
        }

        // Auth State Observer
        function initAuth() {
            const { onAuthStateChanged } = window;
            const auth = window.auth;
            // Initial call to update UI immediately (sets to guest state)
            updateAuthUI();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateAuthUI();
                if (user) {
                    loadProfile();
                }
            });
        }

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            const profileInfo = document.getElementById('profileInfo');
            const navPic = document.getElementById('navProfilePic');
            const dropdown = document.getElementById('profileDropdown');

            if (currentUser) {
                authSection.classList.remove('active');
                profileInfo.classList.add('active');
                navPic.src = currentUser.photoURL || 'Suahco4.png';
                dropdown.innerHTML = `
                    <a href="#" onclick="showSection('profile')">Edit Profile</a>
                    <a href="#" onclick="signOutUser()">Logout</a>
                `;
            } else {
                authSection.classList.add('active');
                profileInfo.classList.remove('active');
                navPic.src = 'Suahco4.png';
                dropdown.innerHTML = `
                    <a href="#" onclick="showSection('profile')">Login</a>
                `;
            }
            // Ensure dropdown is hidden after update (prevents flash on refresh)
            dropdown.classList.remove('active');
            // FIXED: Close mobile nav after UI update
            closeMobileNav();
        }

        // Toggle between sign up/login form
        function toggleAuthForm() {
            const submitBtn = document.getElementById('authSubmit');
            const toggleBtn = document.getElementById('toggleAuth');
            if (submitBtn.textContent === 'Sign Up') {
                submitBtn.textContent = 'Login';
                toggleBtn.textContent = 'Or Sign Up Instead';
            } else {
                submitBtn.textContent = 'Sign Up';
                toggleBtn.textContent = 'Or Login Instead';
            }
        }

        // Function to highlight scores below threshold in red
        function updateScoreColor(input) {
            const value = parseFloat(input.value);
            if (value !== '' && !isNaN(value) && value < currentThreshold) {
                input.classList.add('low-score');
            } else {
                input.classList.remove('low-score');
            }
        }

        // UPDATED: Event delegation for real-time color updates (now debounced)
        const debouncedUpdateColor = debounce(updateScoreColor, 300);
        document.addEventListener('input', function(e) {
            if (e.target.type === 'number' && e.target.closest('#gradeTable')) {
                debouncedUpdateColor(e.target);
            }
        });

        // Function to add a new subject row (with optional default name)
        function addSubjectRow(defaultName = '') {
            subjectCount++;
            const tbody = document.querySelector('#gradeTable tbody');
            const row = document.createElement('tr');
            let scoreInputs = '';
            for (let i = 0; i < numScoreColumns; i++) {
                scoreInputs += `<td><input type="number" min="0" max="100" placeholder="Score"></td>`;
            }
            row.innerHTML = `
                <td>
                    <input type="text" value="${defaultName}" placeholder="Enter subject name">
                    <button class="remove-btn">Remove</button>
                </td>
                ${scoreInputs}
                <td class="average-cell">0.00</td>
            `;
            tbody.appendChild(row);
            clearError();
        }

        // Function to remove a row
        function removeRow(button) {
            button.closest('tr').remove();
            clearError();
        }

        // Show/hide download buttons
        function toggleDownloadBtns(show) {
            const csvBtn = document.getElementById('downloadBtn');
            const pdfBtn = document.getElementById('pdfBtn');
            if (csvBtn) csvBtn.style.display = show ? 'inline-block' : 'none';
            if (pdfBtn) pdfBtn.style.display = show ? 'inline-block' : 'none';
        }

        // UPDATED: Download table as CSV (added empty table check)
        function downloadCSV() {
            // FIXED: Add validation like PDF
            if (activeColumns.length === 0) {
                alert('No scores entered. Calculate averages first!');
                return;
            }
            const table = document.getElementById('gradeTable');
            const tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
            let csvContent = '';

            // Dynamic headers: Subject + Active Periods + Subject Average
            const headers = ['Subject'];
            activeColumns.forEach(i => headers.push(columnNames[i]));
            headers.push('Subject Average');
            csvContent += headers.join(',') + '\n';

            // Data rows (only tbody, filter columns)
            tbodyRows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                if (cells.length === 0) return;

                const rowData = [];
                rowData.push(`"${cells[0].querySelector('input') ? (cells[0].querySelector('input').value || '') : cells[0].textContent.trim()}"`); // Subject

                // Only active columns
                activeColumns.forEach(i => {
                    const cell = cells[i + 1]; // +1 skips subject column
                    const input = cell.querySelector('input');
                    rowData.push(`"${input ? (input.value || '') : cell.textContent.trim()}"`);
                });

                rowData.push(`"${cells[cells.length - 1].textContent.trim()}"`); // Subject Average
                csvContent += rowData.join(',') + '\n';
            });

            // Add footer row (period averages, filtered)
            const footerRow = ['Period Averages'];
            activeColumns.forEach(i => {
                const avgId = columnIdMap[i];
                const avgEl = document.getElementById(avgId);
                footerRow.push(`"${avgEl ? avgEl.textContent : '0.00'}"`);
            });
            footerRow.push(`"${document.getElementById('overallAverage').textContent}"`); // Overall
            csvContent += footerRow.join(',') + '\n';

            // Filename with periods
            const includeDate = localStorage.getItem('dateInExport') !== 'false';
            const dateStr = includeDate ? `-${new Date().toISOString().split('T')[0]}` : '';
            const periodStr = activeColumns.length > 0 ? ` - ${activeColumns.map(i => columnNames[i]).join(', ')}` : '';
            const filename = `grade-matrix${periodStr}${dateStr}.csv`;

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Download table as PDF (filtered to active columns, with checks & footer)
        function downloadPDF() {
            // Enhanced check
            if (activeColumns.length === 0) {
                alert('No scores entered. Calculate averages first!');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const tableData = [];
                
                // Dynamic headers: Subject + Active Periods + Subject Average
                const tableHeaders = ['Subject'];
                activeColumns.forEach(i => tableHeaders.push(columnNames[i]));
                tableHeaders.push('Subject Average');

                // Collect data from table (only tbody rows, filter columns)
                const tbodyRows = document.querySelectorAll('#gradeTable tbody tr');
                tbodyRows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    if (cells.length === 0) return;

                    const rowData = [];
                    rowData.push(cells[0].querySelector('input') ? (cells[0].querySelector('input').value || '') : cells[0].textContent.trim()); // Subject

                    // Only active columns
                    activeColumns.forEach(i => {
                        const cell = cells[i + 1]; // +1 skips subject column
                        const input = cell.querySelector('input');
                        rowData.push(input ? (input.value || '') : cell.textContent.trim());
                    });

                    rowData.push(cells[cells.length - 1].textContent.trim()); // Subject Average
                    tableData.push(rowData);
                });

                if (tableData.length === 0) {
                    alert('No data to export. Add subjects and scores first.');
                    return;
                }

                // Add table to PDF
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: 30,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [44, 73, 94] }, // Dark blue header
                    margin: { left: 10, right: 10 }
                });

                // Add title, periods note, and overall avg
                doc.setFontSize(16);
                doc.text('Grade Matrix Report', 14, 10);
                const periodStr = activeColumns.length > 0 ? ` (Periods: ${activeColumns.map(i => columnNames[i].substring(0, 6)).join(', ')})` : ''; // FIXED: Truncate for filename
                doc.setFontSize(10);
                doc.text(`Filtered to entered data${periodStr}`, 14, 20);
                doc.setFontSize(12);
                doc.text(`Overall Average: ${document.getElementById('overallAverage').textContent}`, 14, doc.lastAutoTable.finalY + 10);

                // Add timestamp footer
                const pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, pageHeight - 10);

                // Filename with periods (truncated)
                const includeDate = localStorage.getItem('dateInExport') !== 'false';
                const dateStr = includeDate ? `-${new Date().toISOString().split('T')[0]}` : '';
                const periodStrFile = activeColumns.length > 0 ? ` - ${activeColumns.map(i => columnNames[i].substring(0, 6)).join(',')}` : ''; // FIXED: Truncate
                const filename = `grade-matrix${periodStrFile}${dateStr}.pdf`;

                // Download
                doc.save(filename);
            } catch (err) {
                console.error('PDF Export Error:', err);
                showError('PDF export failed. Check console or try smaller table.');
            }
        }

        // NEW: Toggle GPA mode
        function toggleGPAScale() {
            isGPAMode = document.getElementById('gpaToggle').checked;
            localStorage.setItem('gpaMode', isGPAMode);
        }

        // UPDATED: Function to calculate averages (with GPA scaling)
        function calculateAverages() {
            try {
                const rows = document.querySelectorAll('#gradeTable tbody tr');
                if (rows.length === 0) {
                    showError('Please add at least one subject.');
                    return;
                }

                // UPDATED: GPA scaling function
                const scale = isGPAMode ? (score) => Math.min(4.0, score / 25) : (score) => score;  // Rough 4.0 mapping

                const columnTotals = new Array(numScoreColumns).fill(0);
                const columnCounts = new Array(numScoreColumns).fill(0);
                let grandTotal = 0;
                let grandCount = 0;
                let invalidSubjects = [];
                lastSubjectAvgs = []; // Reset for stats

                columnIdMap.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '0.00';
                });

                for (let r = 0; r < rows.length; r++) {
                    const row = rows[r];
                    const subjectInput = row.querySelector('input[type="text"]');
                    const scoreInputs = row.querySelectorAll('input[type="number"]');
                    const avgCell = row.querySelector('.average-cell');

                    if (!subjectInput || subjectInput.value.trim() === '') {
                        invalidSubjects.push(r + 1);
                        continue;
                    }

                    let subjectTotal = 0;
                    let subjectValid = 0;

                    for (let i = 0; i < scoreInputs.length; i++) {
                        const input = scoreInputs[i];
                        if (!input.value) continue;

                        let score = parseFloat(input.value);
                        if (isNaN(score) || score < 0 || score > 100) {
                            showError('Scores must be numbers between 0 and 100.');
                            return;
                        }
                        if (score > 100) score = 100; // Clamp to 100

                        // UPDATED: Apply scaling
                        const scaledScore = scale(score);
                        subjectTotal += scaledScore;
                        subjectValid++;
                        grandTotal += scaledScore;
                        grandCount++;

                        columnTotals[i] += scaledScore;
                        columnCounts[i]++;
                    }

                    const subjectAvg = subjectValid > 0 ? (subjectTotal / subjectValid).toFixed(2) : '0.00';
                    // UPDATED: Append letter grade
                    const letter = getLetterGrade(subjectAvg);
                    if (avgCell) avgCell.innerHTML = `${subjectAvg} <small>(${letter})</small>`;
                    lastSubjectAvgs.push({ name: subjectInput.value.trim(), avg: parseFloat(subjectAvg) });
                }

                if (invalidSubjects.length > 0) {
                    showError(`Please name subjects in rows: ${invalidSubjects.join(', ')}`);
                    return;
                }

                for (let i = 0; i < numScoreColumns; i++) {
                    const colAvg = columnCounts[i] > 0 ? (columnTotals[i] / columnCounts[i]).toFixed(2) : '0.00';
                    const colId = columnIdMap[i];
                    const el = document.getElementById(colId);
                    if (el) el.innerHTML = `${colAvg} <small>(${getLetterGrade(colAvg)})</small>`; // UPDATED: Append letter
                }

                const overallAvg = grandCount > 0 ? (grandTotal / grandCount).toFixed(2) : '0.00';
                lastOverallAvg = overallAvg;
                const overallEl = document.getElementById('overallAverage');
                if (overallEl) overallEl.innerHTML = `${overallAvg} <small>(${getLetterGrade(overallAvg)})</small>`; // UPDATED: Append letter

                // Track active columns (with data)
                activeColumns = [];
                for (let i = 0; i < numScoreColumns; i++) {
                    if (columnCounts[i] > 0) {
                        activeColumns.push(i);
                    }
                }

                displayResult(overallAvg);
                generateStats(); // Update profile stats
                clearError();
                toggleDownloadBtns(true);
            } catch (err) {
                console.error(err);
                showError('An unexpected error occurred. Check the console for details.');
            }
        }

        // UPDATED: Function to display result (with GPA support)
        function displayResult(average) {
            const resultDiv = document.getElementById('result');
            const letter = getLetterGrade(average);
            let displayText = `Overall Average Grade: ${average} (${letter})`;
            if (isGPAMode) {
                const gpa = (parseFloat(average) / 25).toFixed(2); // Rough 4.0 mapping (90-100=A=4.0, etc.)
                displayText += ` | GPA: ${gpa}/4.0 (GPA Mode)`;
            }
            resultDiv.innerHTML = `<div class="result">${displayText}</div>`;
        }

        // Function to show error
        function showError(message) {
            const errorDiv = document.getElementById('error');
            if (errorDiv) errorDiv.textContent = message;
        }

        // Function to clear error
        function clearError() {
            const errorDiv = document.getElementById('error');
            if (errorDiv) errorDiv.textContent = '';
        }

        // FIXED: Toggle mobile nav menu - now closes if open on section change
        function toggleNav() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }

        // FIXED: Close mobile nav if open (no toggle - force close)
        function closeMobileNav() {
            const menu = document.getElementById('navMenu');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
            }
        }

        // Toggle profile dropdown
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        // Hide dropdown on outside click
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('profileDropdown');
            const profilePic = document.querySelector('.profile-pic');
            if (!profilePic.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Logout function (now uses Firebase)
        function logout() {
            signOutUser();
        }

        // Updated Profile functions (integrates with Firebase)
        function loadProfile() {
            if (currentUser) {
                document.getElementById('userName').value = currentUser.displayName || '';
                document.getElementById('userEmail').value = currentUser.email || '';
                const picSrc = currentUser.photoURL || 'Suahco4.png';
                document.getElementById('profilePicPreview').src = picSrc;
                document.getElementById('navProfilePic').src = picSrc;
                generateStats();
                loadSessions();
                // NEW: Refresh stats on load
                if (lastOverallAvg !== '0.00') generateStats();
            }
        }

        function saveProfile() {
            if (!currentUser) return alert('Please log in first.');
            const name = document.getElementById('userName').value;
            const { updateProfile } = window;
            updateProfile(currentUser, { displayName: name })
                .then(() => {
                    alert('Profile saved!');
                    updateNavPic(currentUser.photoURL || 'Suahco4.png');
                })
                .catch((error) => {
                    console.error('Profile Update Error:', error);
                    alert('Failed to save profile.');
                });
        }

        function handlePicUpload(event) {
            const file = event.target.files[0];
            if (file && currentUser) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('profilePicPreview');
                    img.src = e.target.result;
                    updateNavPic(e.target.result);
                    // TODO: Upload to Firebase Storage if needed
                };
                reader.readAsDataURL(file);
            }
        }

        function updateNavPic(src) {
            document.getElementById('navProfilePic').src = src;
        }

        function saveSession() {
            const tableData = [];
            document.querySelectorAll('#gradeTable tbody tr').forEach(row => {
                const subjectInput = row.querySelector('input[type="text"]');
                const scoreInputs = Array.from(row.querySelectorAll('input[type="number"]')).map(input => input.value);
                tableData.push({
                    subject: subjectInput ? subjectInput.value : '',
                    scores: scoreInputs
                });
            });
            const session = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                data: tableData,
                overallAvg: lastOverallAvg
            };
            let sessions = JSON.parse(localStorage.getItem('savedSessions')) || [];
            sessions.unshift(session); // Add to front
            if (sessions.length > 5) sessions = sessions.slice(0, 5); // Limit to 5
            localStorage.setItem('savedSessions', JSON.stringify(sessions));
            loadSessions();
            alert('Session saved!');
        }

        function loadSessions() {
            const sessions = JSON.parse(localStorage.getItem('savedSessions')) || [];
            const list = document.getElementById('sessionList');
            list.innerHTML = '';
            sessions.forEach(session => {
                const li = document.createElement('li');
                li.className = 'session-item';
                li.innerHTML = `
                    <span>${session.timestamp} (Avg: ${session.overallAvg}%)</span>
                    <div>
                        <button class="small-btn" onclick="loadSession(${session.id})">Load</button>
                        <button class="remove-btn" onclick="deleteSession(${session.id})">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // UPDATED: Load session (now auto-recalculates)
        function loadSession(id) {
            const sessions = JSON.parse(localStorage.getItem('savedSessions')) || [];
            const session = sessions.find(s => s.id === id);
            if (!session) return alert('Session not found!');
            if (confirm(`Load session from ${session.timestamp}? This will overwrite current data.`)) {
                // Clear table
                document.querySelector('#gradeTable tbody').innerHTML = '';
                // Add rows
                session.data.forEach(item => {
                    addSubjectRow(item.subject);
                    const inputs = document.querySelectorAll('#gradeTable tbody tr:last-child input[type="number"]');
                    item.scores.forEach((score, i) => {
                        if (inputs[i]) inputs[i].value = score;
                    });
                });
                // NEW: Auto-recalculate after DOM update
                setTimeout(() => calculateAverages(), 100);
                showSection('grades');
                alert('Session loaded!');
            }
        }

        function deleteSession(id) {
            if (confirm('Delete this session?')) {
                let sessions = JSON.parse(localStorage.getItem('savedSessions')) || [];
                sessions = sessions.filter(s => s.id !== id);
                localStorage.setItem('savedSessions', JSON.stringify(sessions));
                loadSessions();
            }
        }

        // UPDATED: Generate stats (with GPA support)
        function generateStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (lastSubjectAvgs.length === 0) {
                statsGrid.innerHTML = '<p class="stat-item">No data yet. Calculate grades first!</p>';
                return;
            }
            const totalSubjects = lastSubjectAvgs.length;
            const bestSubject = lastSubjectAvgs.reduce((max, curr) => curr.avg > max.avg ? curr : max);
            const worstSubject = lastSubjectAvgs.reduce((min, curr) => curr.avg < min.avg ? curr : min);
            let overallDisplay = `${lastOverallAvg}`;
            if (isGPAMode) {
                const gpa = (parseFloat(lastOverallAvg) / 25).toFixed(2);
                overallDisplay += ` (${gpa}/4.0 GPA)`;
            }
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div>Total Subjects</div>
                    <div class="stat-value">${totalSubjects}</div>
                </div>
                <div class="stat-item">
                    <div>Overall Avg</div>
                    <div class="stat-value">${overallDisplay}</div>
                </div>
                <div class="stat-item">
                    <div>Best: ${bestSubject.name}</div>
                    <div class="stat-value">${bestSubject.avg}</div>
                </div>
                <div class="stat-item">
                    <div>Worst: ${worstSubject.name}</div>
                    <div class="stat-value">${worstSubject.avg}</div>
                </div>
            `;
        }

        // UPDATED: Contact functions (with fixed auto-reply)
        function submitContactForm(e) {
            e.preventDefault();
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const subject = document.getElementById('contactSubject').value.trim();
            const message = document.getElementById('contactMessage').value.trim();

            if (!name || !email || !subject || !message) {
                alert('Please fill in all fields.');
                return;
            }

            // Log for debugging
            console.log('Contact Form Submitted:', { name, email, subject, message });

            // Send main contact email via EmailJS
            emailjs.send('service_t4jdpwc', 'template_bq7h8n6', {
                name: name,
                email: email,
                subject: subject,
                message: message
            }).then((result) => {
                console.log('Main EmailJS Success:', result.text);

                // FIXED: Send dedicated auto-reply to user (only if main succeeds)
                console.log('Sending auto-reply...');
                emailjs.send('service_t4jdpwc', 'template_awyrou5', {  // Dedicated auto-reply template
                    to_name: name,
                    to_email: email,
                    reply_subject: `Re: ${subject} - Thanks for reaching out!`,
                    reply_message: `Hi ${name}! We received your message about "${subject}". Our team will review it within 24-48 hours. In the meantime, check our Help section for quick tips. Best, Grade Calculator Team`
                }).then((replyResult) => {
                    console.log('Auto-Reply Success:', replyResult.text);
                }).catch((replyError) => {
                    console.warn('Auto-Reply failed (non-critical):', replyError);
                    // ENHANCED: Optional user notification on partial failure
                    // alert('Message sent, but auto-reply delayed‚Äîcheck spam folder!');
                });

                alert('Message sent successfully! Check your email for an auto-reply confirmation. We\'ll get back to you soon.');
                document.getElementById('contactForm').reset();
            }, (error) => {
                console.error('Main EmailJS Error:', error);
                alert('Failed to send message. Please try again or email us directly.');
            });
        }

        // FIXED: Show section (handles all toggles + SEO meta updates) - Closes mobile nav
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Show target
            if (section === 'grades') {
                const gradesSec = document.getElementById('grades-section');
                if (gradesSec) gradesSec.style.display = 'block';
                document.getElementById('result').style.display = 'block';
                document.getElementById('error').style.display = 'block';
            } else if (section === 'help') {
                const helpSec = document.getElementById('help-section');
                if (helpSec) helpSec.style.display = 'block';
                document.querySelectorAll('.accordion-content').forEach(content => content.classList.remove('active'));
            } else if (section === 'settings') {
                const settingsSec = document.getElementById('settings-section');
                if (settingsSec) settingsSec.style.display = 'block';
                loadSettings();
            } else if (section === 'profile') {
                const profileSec = document.getElementById('profile-section');
                if (profileSec) profileSec.style.display = 'block';
                loadProfile();
            } else if (section === 'ai') { // UPDATED: Now opens floating chat instead
                toggleFloatingChat();
                return; // Don't proceed to show full section
            } else if (section === 'contact') {
                const contactSec = document.getElementById('contact-section');
                if (contactSec) contactSec.style.display = 'block';
                document.getElementById('contactName').focus();
            } else if (section === 'privacy') {
                const privacySec = document.getElementById('privacy-section');
                if (privacySec) privacySec.style.display = 'block';
                document.querySelectorAll('.accordion-content').forEach(content => content.classList.remove('active'));
                document.querySelector('.accordion-content').classList.add('active');
            } else if (section === 'terms') {
                const termsSec = document.getElementById('terms-section');
                if (termsSec) termsSec.style.display = 'block';
                document.querySelectorAll('.accordion-content').forEach(content => content.classList.remove('active'));
                document.querySelector('.accordion-content').classList.add('active');
            }
            
            // FIXED: Force close mobile nav on section change
            closeMobileNav();
            document.getElementById('profileDropdown').classList.remove('active');
            
            // Update SEO meta for this section
            updateMetaForSection(section);
        }

        // Toggle accordion sections
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');
            
            // Close all others
            document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
            
            // Toggle this one
            if (!isActive) {
                content.classList.add('active');
            }
        }

        // Load saved settings
        function loadSettings() {
            // Theme
            const isDark = localStorage.getItem('darkMode') === 'true';
            document.getElementById('themeToggle').checked = isDark;
            if (isDark) document.body.classList.add('dark-mode');
            
            // Threshold
            const threshold = localStorage.getItem('lowScoreThreshold') || 70;
            document.getElementById('thresholdInput').value = threshold;
            document.getElementById('currentThreshold').textContent = threshold;
            currentThreshold = parseInt(threshold);
            
            // NEW: GPA Mode
            isGPAMode = localStorage.getItem('gpaMode') === 'true';
            document.getElementById('gpaToggle').checked = isGPAMode;
            
            // Default subjects
            const defaults = localStorage.getItem('defaultSubjects') || 'Mathematics,English,Science,History';
            document.getElementById('defaultSubjectsInput').value = defaults;
            
            // Date in export
            const dateInExport = localStorage.getItem('dateInExport') !== 'false';
            document.getElementById('dateInFilename').checked = dateInExport;
        }

        // Toggle dark mode
        function toggleTheme() {
            const isDark = document.getElementById('themeToggle').checked;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
        }

        // UPDATED: Update low score threshold (with validation)
        function updateThreshold() {
            const newVal = parseInt(document.getElementById('thresholdInput').value);
            if (isNaN(newVal) || newVal < 0 || newVal > 100) {
                showError('Threshold must be a number between 0-100.');
                return;
            }
            currentThreshold = newVal;
            document.getElementById('currentThreshold').textContent = newVal;
            localStorage.setItem('lowScoreThreshold', newVal);
            // Re-apply to all inputs
            document.querySelectorAll('#gradeTable input[type="number"]').forEach(input => {
                updateScoreColor(input);
            });
            clearError();
        }

        function applyThreshold() {
            updateThreshold();
            alert(`Threshold updated to ${currentThreshold}! Highlights refreshed.`);
        }

        // Save default subjects
        function saveDefaultSubjects() {
            const subjects = document.getElementById('defaultSubjectsInput').value;
            localStorage.setItem('defaultSubjects', subjects);
            alert('Default subjects saved! Refresh page to see changes.');
        }

        // Toggle date in exports
        function toggleDateInExport() {
            const includeDate = document.getElementById('dateInFilename').checked;
            localStorage.setItem('dateInExport', includeDate);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Clear all subjects and scores? This cannot be undone.')) {
                document.querySelector('#gradeTable tbody').innerHTML = '';
                const defaults = localStorage.getItem('defaultSubjects') || 'Mathematics,English,Science,History';
                defaults.split(',').forEach(name => addSubjectRow(name.trim()));
                toggleDownloadBtns(false);
                activeColumns = [];
                columnIdMap.forEach(id => document.getElementById(id).textContent = '0.00');
                document.getElementById('overallAverage').textContent = '0.00';
                document.getElementById('result').innerHTML = '';
                clearError();
                alert('Data cleared! Back to defaults.');
                showSection('grades');
            }
        }

        // NEW: Keyboard shortcut for calculate (Ctrl+Enter)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                calculateAverages();
            }
        });

        // Event listeners & Initial Load
        document.addEventListener('DOMContentLoaded', function() {
            // FIXED: Force close mobile nav on load/refresh
            closeMobileNav();

            // Initialize EmailJS
            emailjs.init('mMoFbLBQtA226NQY_');

            // Initialize Firebase Auth (now calls updateAuthUI immediately)
            initAuth();

            // Bind main buttons
            document.getElementById('addSubject').addEventListener('click', () => addSubjectRow(''));
            document.getElementById('calculate').addEventListener('click', calculateAverages);
            
            // Event delegation for remove buttons (dynamic)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-btn')) {
                    removeRow(e.target);
                }
            });

            // Auth form submit
            document.getElementById('authForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const name = document.getElementById('userName').value || email.split('@')[0];
                const submitBtn = document.getElementById('authSubmit');
                if (submitBtn.textContent === 'Sign Up') {
                    signUpWithEmail(email, password, name);
                } else {
                    signInWithEmail(email, password);
                }
            });

            // Toggle auth form
            document.getElementById('toggleAuth').addEventListener('click', toggleAuthForm);

            // Contact form submit
            document.getElementById('contactForm').addEventListener('submit', submitContactForm);

            // Load defaults
            const defaultSubjects = ['Mathematics', 'English', 'Science', 'History'];
            defaultSubjects.forEach(name => addSubjectRow(name));

            // Load settings & profile
            loadSettings();
            toggleDownloadBtns(false);
            showSection('grades'); // This will also set initial SEO meta
        });
    </script>
</body>
</html>


